// Generated by psc version 0.9.1
"use strict";
var Prelude = require("../Prelude");
var Data_Maybe = require("../Data.Maybe");
var Data_Either = require("../Data.Either");
var Data_Int = require("../Data.Int");
var Data_Array = require("../Data.Array");
var Data_Foreign_EasyFFI = require("../Data.Foreign.EasyFFI");
var Control_Monad_Eff = require("../Control.Monad.Eff");
var Control_Monad_Eff_Class = require("../Control.Monad.Eff.Class");
var Control_Monad_Eff_Console = require("../Control.Monad.Eff.Console");
var Control_Monad_Eff_Exception = require("../Control.Monad.Eff.Exception");
var Control_Monad_Eff_Ref = require("../Control.Monad.Eff.Ref");
var Node_Express_Types = require("../Node.Express.Types");
var Node_Express_App = require("../Node.Express.App");
var Node_Express_Handler = require("../Node.Express.Handler");
var Node_Express_Request = require("../Node.Express.Request");
var Node_Express_Response = require("../Node.Express.Response");
var Node_HTTP = require("../Node.HTTP");
var Data_Unit = require("../Data.Unit");
var Data_Function = require("../Data.Function");
var Control_Bind = require("../Control.Bind");
var Data_Semigroup = require("../Data.Semigroup");
var Data_Show = require("../Data.Show");
var Data_Semiring = require("../Data.Semiring");
var Data_Foreign_Class = require("../Data.Foreign.Class");
var updateTodo = function (id) {
    return function (newDesc) {
        return function (statedata) {
            var $18 = Data_Array.modifyAt(id)(function (el) {
                var $16 = {};
                for (var $17 in el) {
                    if (el.hasOwnProperty($17)) {
                        $16[$17] = el[$17];
                    };
                };
                $16.desc = newDesc;
                return $16;
            })(statedata);
            if ($18 instanceof Data_Maybe.Nothing) {
                return {
                    state: statedata, 
                    value: new Data_Either.Left("No such ID")
                };
            };
            if ($18 instanceof Data_Maybe.Just) {
                return {
                    state: $18.value0, 
                    value: new Data_Either.Right(Data_Unit.unit)
                };
            };
            throw new Error("Failed pattern match at ToDoServer line 50, column 3 - line 52, column 56: " + [ $18.constructor.name ]);
        };
    };
};
var setDone = function (id) {
    return function (statedata) {
        var $22 = Data_Array.modifyAt(id)(function (el) {
            var $20 = {};
            for (var $21 in el) {
                if (el.hasOwnProperty($21)) {
                    $20[$21] = el[$21];
                };
            };
            $20.isDone = true;
            return $20;
        })(statedata);
        if ($22 instanceof Data_Maybe.Nothing) {
            return {
                state: statedata, 
                value: new Data_Either.Left("No such ID")
            };
        };
        if ($22 instanceof Data_Maybe.Just) {
            return {
                state: $22.value0, 
                value: new Data_Either.Right(Data_Unit.unit)
            };
        };
        throw new Error("Failed pattern match at ToDoServer line 62, column 3 - line 64, column 56: " + [ $22.constructor.name ]);
    };
};
var $$parseInt = function (str) {
    return Data_Function.apply(Data_Maybe.fromMaybe(0))(Data_Int.fromString(str));
};
var updateTodoHandler = function (state) {
    return Control_Bind.bind(Node_Express_Handler.bindHandlerM)(Node_Express_Request.getRouteParam(Node_Express_Types.requestParamString)("id"))(function (v) {
        return Control_Bind.bind(Node_Express_Handler.bindHandlerM)(Node_Express_Request.getQueryParam("desc"))(function (v1) {
            var $26 = [ v, v1 ];
            if ($26.length === 2 && ($26[0] instanceof Data_Maybe.Just && $26[1] instanceof Data_Maybe.Just)) {
                return Control_Bind.bind(Node_Express_Handler.bindHandlerM)(Data_Function.apply(Control_Monad_Eff_Class.liftEff(Node_Express_Handler.monadEffHandlerM))(Data_Function.apply(Control_Monad_Eff_Ref["modifyRef'"](state))(updateTodo($$parseInt(($26[0]).value0))(($26[1]).value0))))(function (v2) {
                    if (v2 instanceof Data_Either.Left) {
                        return Data_Function.apply(Node_Express_Handler.nextThrow)(Control_Monad_Eff_Exception.error(v2.value0));
                    };
                    return Node_Express_Response.sendJson({
                        status: "Updated"
                    });
                });
            };
            return Data_Function.apply(Node_Express_Handler.nextThrow)(Control_Monad_Eff_Exception.error("Id and Description are required"));
        });
    });
};
var logger = function (state) {
    return Control_Bind.bind(Node_Express_Handler.bindHandlerM)(Data_Function.apply(Control_Monad_Eff_Class.liftEff(Node_Express_Handler.monadEffHandlerM))(Control_Monad_Eff_Ref.readRef(state)))(function (v) {
        return Control_Bind.bind(Node_Express_Handler.bindHandlerM)(Node_Express_Request.getOriginalUrl)(function (v1) {
            return Control_Bind.bind(Node_Express_Handler.bindHandlerM)(Data_Function.apply(Control_Monad_Eff_Class.liftEff(Node_Express_Handler.monadEffHandlerM))(Control_Monad_Eff_Console.log(">>> " + (v1 + (" count =" + Data_Function.apply(Data_Show.show(Data_Show.showInt))(Data_Array.length(v)))))))(function () {
                return Node_Express_Handler.next;
            });
        });
    });
};
var initState = Control_Monad_Eff_Ref.newRef([  ]);
var help = {
    name: "Todo example", 
    purpose: "To present a subset of purescript-express package capabilities", 
    howToUse: {
        listTodos: "/list", 
        createTodo: "/create?desc=Do+something", 
        doTodo: "/done/:id", 
        updateTodo: "/update/:id?desc=Do+something+else", 
        deleteTodo: "/delete/:id"
    }, 
    forkMe: "https://github.com/dancingrobot84/purescript-express"
};
var indexHandler = function (v) {
    return Node_Express_Response.sendJson(help);
};
var getTodosWithIndexes = function (items) {
    return Data_Array.zipWith(function (item) {
        return function (idx) {
            return {
                id: idx, 
                desc: item.desc, 
                isDone: item.isDone
            };
        };
    })(items)(Data_Function.apply(Data_Array.range(0))(Data_Array.length(items)));
};
var listTodosHandler = function (state) {
    return Control_Bind.bind(Node_Express_Handler.bindHandlerM)(Data_Function.apply(Control_Monad_Eff_Class.liftEff(Node_Express_Handler.monadEffHandlerM))(Control_Monad_Eff_Ref.readRef(state)))(function (v) {
        return Data_Function.apply(Node_Express_Response.sendJson)(getTodosWithIndexes(v));
    });
};
var errorHandler = function (state) {
    return function (err) {
        return Control_Bind.bind(Node_Express_Handler.bindHandlerM)(Node_Express_Response.setStatus(400))(function () {
            return Node_Express_Response.sendJson({
                error: Control_Monad_Eff_Exception.message(err)
            });
        });
    };
};
var doTodoHandler = function (state) {
    return Control_Bind.bind(Node_Express_Handler.bindHandlerM)(Node_Express_Request.getRouteParam(Node_Express_Types.requestParamString)("id"))(function (v) {
        if (v instanceof Data_Maybe.Nothing) {
            return Data_Function.apply(Node_Express_Handler.nextThrow)(Control_Monad_Eff_Exception.error("Id is required"));
        };
        if (v instanceof Data_Maybe.Just) {
            return Control_Bind.bind(Node_Express_Handler.bindHandlerM)(Data_Function.apply(Control_Monad_Eff_Class.liftEff(Node_Express_Handler.monadEffHandlerM))(Data_Function.apply(Control_Monad_Eff_Ref["modifyRef'"](state))(setDone($$parseInt(v.value0)))))(function (v1) {
                if (v1 instanceof Data_Either.Left) {
                    return Data_Function.apply(Node_Express_Handler.nextThrow)(Control_Monad_Eff_Exception.error(v1.value0));
                };
                return Node_Express_Response.sendJson({
                    status: "Done"
                });
            });
        };
        throw new Error("Failed pattern match at ToDoServer line 145, column 3 - line 151, column 46: " + [ v.constructor.name ]);
    });
};
var deleteTodo = function (id) {
    return function (statedata) {
        var $43 = Data_Array.deleteAt(id)(statedata);
        if ($43 instanceof Data_Maybe.Nothing) {
            return {
                state: statedata, 
                value: new Data_Either.Left("No such ID")
            };
        };
        if ($43 instanceof Data_Maybe.Just) {
            return {
                state: $43.value0, 
                value: new Data_Either.Right(Data_Unit.unit)
            };
        };
        throw new Error("Failed pattern match at ToDoServer line 56, column 3 - line 58, column 56: " + [ $43.constructor.name ]);
    };
};
var deleteTodoHandler = function (state) {
    return Control_Bind.bind(Node_Express_Handler.bindHandlerM)(Node_Express_Request.getRouteParam(Node_Express_Types.requestParamString)("id"))(function (v) {
        if (v instanceof Data_Maybe.Nothing) {
            return Data_Function.apply(Node_Express_Handler.nextThrow)(Control_Monad_Eff_Exception.error("Id is required"));
        };
        if (v instanceof Data_Maybe.Just) {
            return Control_Bind.bind(Node_Express_Handler.bindHandlerM)(Data_Function.apply(Control_Monad_Eff_Class.liftEff(Node_Express_Handler.monadEffHandlerM))(Data_Function.apply(Control_Monad_Eff_Ref["modifyRef'"](state))(deleteTodo($$parseInt(v.value0)))))(function (v1) {
                if (v1 instanceof Data_Either.Left) {
                    return Data_Function.apply(Node_Express_Handler.nextThrow)(Control_Monad_Eff_Exception.error(v1.value0));
                };
                return Node_Express_Response.sendJson({
                    status: "Deleted"
                });
            });
        };
        throw new Error("Failed pattern match at ToDoServer line 134, column 3 - line 140, column 49: " + [ v.constructor.name ]);
    });
};
var addTodo = function (todo) {
    return function (statedata) {
        return {
            state: Data_Array.snoc(statedata)(todo), 
            value: new Data_Either.Right(Data_Array.length(statedata) + 1 | 0)
        };
    };
};
var createTodoHandler = function (state) {
    return Control_Bind.bind(Node_Express_Handler.bindHandlerM)(Node_Express_Request.getQueryParam("desc"))(function (v) {
        if (v instanceof Data_Maybe.Nothing) {
            return Data_Function.apply(Node_Express_Handler.nextThrow)(Control_Monad_Eff_Exception.error("Description is required"));
        };
        if (v instanceof Data_Maybe.Just) {
            return Control_Bind.bind(Node_Express_Handler.bindHandlerM)(Data_Function.apply(Control_Monad_Eff_Class.liftEff(Node_Express_Handler.monadEffHandlerM))(Data_Function.apply(Control_Monad_Eff_Ref["modifyRef'"](state))(addTodo({
                desc: v.value0, 
                isDone: false
            }))))(function (v1) {
                return Node_Express_Response.sendJson({
                    status: "Created", 
                    id: v1
                });
            });
        };
        throw new Error("Failed pattern match at ToDoServer line 113, column 3 - line 117, column 46: " + [ v.constructor.name ]);
    });
};
var appSetup = function (state) {
    return Control_Bind.bind(Node_Express_App.bindAppM)(Data_Function.apply(Control_Monad_Eff_Class.liftEff(Node_Express_App.monadEffAppM))(Control_Monad_Eff_Console.log("Setting up")))(function () {
        return Control_Bind.bind(Node_Express_App.bindAppM)(Node_Express_App.setProp(Data_Foreign_Class.numberIsForeign)("json spaces")(4.0))(function () {
            return Control_Bind.bind(Node_Express_App.bindAppM)(Node_Express_App.use(logger(state)))(function () {
                return Control_Bind.bind(Node_Express_App.bindAppM)(Node_Express_App.get(Node_Express_Types.routePath)("/")(indexHandler(state)))(function () {
                    return Control_Bind.bind(Node_Express_App.bindAppM)(Node_Express_App.get(Node_Express_Types.routePath)("/list")(listTodosHandler(state)))(function () {
                        return Control_Bind.bind(Node_Express_App.bindAppM)(Node_Express_App.get(Node_Express_Types.routePath)("/create")(createTodoHandler(state)))(function () {
                            return Control_Bind.bind(Node_Express_App.bindAppM)(Node_Express_App.get(Node_Express_Types.routePath)("/update/:id")(updateTodoHandler(state)))(function () {
                                return Control_Bind.bind(Node_Express_App.bindAppM)(Node_Express_App.get(Node_Express_Types.routePath)("/delete/:id")(deleteTodoHandler(state)))(function () {
                                    return Control_Bind.bind(Node_Express_App.bindAppM)(Node_Express_App.get(Node_Express_Types.routePath)("/done/:id")(doTodoHandler(state)))(function () {
                                        return Node_Express_App.useOnError(errorHandler(state));
                                    });
                                });
                            });
                        });
                    });
                });
            });
        });
    });
};
var main = function __do() {
    var v = initState();
    var v1 = Data_Foreign_EasyFFI.unsafeForeignFunction([ "" ])("process.env.PORT || 8080")();
    return Node_Express_App.listenHttp(appSetup(v))(v1)(function (v2) {
        return Data_Function.apply(Control_Monad_Eff_Console.log)("Listening on " + Data_Show.show(Data_Show.showInt)(v1));
    })();
};
module.exports = {
    addTodo: addTodo, 
    appSetup: appSetup, 
    createTodoHandler: createTodoHandler, 
    deleteTodo: deleteTodo, 
    deleteTodoHandler: deleteTodoHandler, 
    doTodoHandler: doTodoHandler, 
    errorHandler: errorHandler, 
    getTodosWithIndexes: getTodosWithIndexes, 
    help: help, 
    indexHandler: indexHandler, 
    initState: initState, 
    listTodosHandler: listTodosHandler, 
    logger: logger, 
    main: main, 
    "parseInt": $$parseInt, 
    setDone: setDone, 
    updateTodo: updateTodo, 
    updateTodoHandler: updateTodoHandler
};
